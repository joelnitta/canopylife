---
title: ""
bibliography: 
  - "references_si.bib"
  - "references_other.yaml"
fontsize: 12pt
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    pandoc_args: [ "--csl", "new-phytologist.csl"]
    includes:
      in_header: new-phytologist.sty
nocite: | 
  @NMNS2008, @Copeland1932, @FloraNSW2019, @Brownsey1987, @Nayar1971, @Lloyd1980, @Zhang2008, @Bierhorst1967, @Martin2006, @Tigerschiold1989, @Tigerschiold1990, @Atkinson1975, @Palmer2003
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE)

# Load analysis results
loadd(list = c(
  "trait_data_for_si",
  "climate_ancova_results",
  "phylosig_binary_traits_strict",
  "correlated_evo_test_strict",
  "best_fit_div_models_moran",
  "func_comm_struc_combined"), 
  cache = canopy_cache)

# Set up captions
# - SI figures
s_fig_nums <- captioner(prefix = "Fig. S", auto_space = FALSE, suffix = ": ")
s_fig_nums(name = "corr-plot", "Correlation plot comparing results of functional community diversity analyses using different sets of traits as input.")
s_fig_nums(name = "cwsd", "Comparison of community-weighted standard deviations (CWSD) in traits of epiphytic and terrestrial fern communities on Moorea, French Polynesia.")

# - SI tables
s_table_nums <- captioner(prefix = "Table S", auto_space = FALSE, suffix = ": ")
s_table_nums(name = "species-list", "List of ferns from Moorea, French Polynesia included in this study")
s_table_nums(name = "trait-values", "Trait values of ferns on Moorea, French Polynesia")
s_table_nums(name = "ancova", "Analysis of covariance (ANCOVA) for climate variables in response to growth habit (epiphytic vs. terrestrial) with elevation as a covariate")
s_table_nums(name = "phylosig-binary-strict", "Phylogenetic signal in binary traits, strict dataset excluding any species whose traits were scored based on taxonomy")
s_table_nums(name = "corr-evo-strict", "Pagel's (1994) test of correlated evolution between binary traits, strict dataset excluding any species whose traits were scored based on taxonomy")
s_table_nums(name = "model-fit", "Best-fitting models explaining community diversity metrics by climate and growth habit")

# Make short versions of citation functions
s_figure <- pryr::partial(s_fig_nums, display = "cite")
s_table <- pryr::partial(s_table_nums, display = "cite")
```

***New Phytologist*** **Supporting Information**

Article title: Life in the canopy: Community trait assessments reveal substantial functional diversity among fern epiphytes

Authors: Joel H. Nitta, James E. Watkins, Jr., and Charles C. Davis

Article acceptance date: 

The following Supporting Information is available for this article:

**`r s_table("species-list")`** List of ferns from Moorea, French Polynesia included in this study

'taxon code' is the name used for that taxon in analyses. 'informal variety' is a number assigned to infraspecific taxa that are morphologically and genetically distinct, but lack formal names distinguishing them. 'name source' indicates the source of the scientific name as follows: IPNI = International Plant Names Index (https://www.ipni.org/), TROPICOS = Missouri Botanical Garden taxonomic database (https://www.tropicos.org/), NCBI = National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi), Murdock and Smith 2003 = @Murdock2003.

**`r s_table("trait-values")`** Trait values of ferns on Moorea, French Polynesia

SLA, specific leaf area. Continuous measurements shown as mean, standard deviation (sample size). 'taxon code' is the name used for that taxon in analyses (see Table S1). For data source, L = lab observation of gametophyte cultured from spore, F = field observation of gametophyte subsequently identified using DNA barcoding, T = morphology inferred based on taxonomy, M = measurement of a field-collected specimen; cited references provided at end of SI.

```{r}
trait_data_for_si %>%
  write_csv(here::here("results/Table_S2.csv"))
```

**`r s_table("ancova")`** Analysis of covariance (ANCOVA) for climate variables in response to growth habit (epiphytic vs. terrestrial) with elevation as a covariate

d.f., degrees of freedom; MS, mean squares.

```{r climate-ancova}
# Format and write out table as CSV file
climate_ancova_results %>% 
  mutate(
    p.value = signif(p.value, 2) %>% format.pval(., digits = 1),
    meansq = round_t(meansq, 2),
    term = case_when(
      term == "habit" ~ "Growth habit",
      term == "el" ~ "Elevation",
      term == "habit:el" ~ "Growth habit × elevation",
      TRUE ~ term
    )
  ) %>%
  select(`Response variable` = variable, `Source of variation` = term, `d.f.` = df, MS = meansq, P = p.value) %>%
  write_csv(here::here("results/Table_S3.csv"))

```

**`r s_table("phylosig-binary-strict")`** Phylogenetic signal in binary traits, strict dataset excluding any species whose traits were scored based on taxonomy

P_rnd, probability of obtaining the observed value of \D under random trait evolution; P_bm, probability of obtaining the observed value of \D under simulation of trait evolution by Brownian motion.

```{r phylosig-binary-strict}
# Format and write out table as CSV file
phylosig_binary_traits_strict %>%
  mutate(D = round_t(D, 2)) %>%
  mutate(trait = factor(
    trait, 
    levels = c("habit", "gemmae", "glands", "hairs","morphotype"))) %>%
  mutate(trait = lvls_revalue(
    trait,
    new_levels = c("Epiphytic growth", "Gemmae", "Glands", "Hairs", "Cordate morphotype"))) %>%
  arrange(trait) %>%
  select(Trait = trait, `Number of presences` = num_present, `Number of absences` = num_absent, D,
         P_rnd = prob_random, P_bm = prob_brownian) %>%
  write_csv(here::here("results/Table_S4.csv"))
```

**`r s_table("corr-evo-strict")`** Pagel's [-@Pagel1994] test of correlated evolution between binary traits, strict dataset excluding any species whose traits were scored based on taxonomy

LL, log likelihood. Each gametophyte trait was coded as a binary trait and tested for correlated evolution with growth habit (epiphytic vs. terrestrial). Lower log likelihood for the dependent model indicates correlation with growth habit. 

```{r corr-evo-strict}
# Format and write out table as CSV file
correlated_evo_test_strict %>%
  mutate(trait = factor(
    trait, 
    levels = c("gemmae", "glands", "hairs","morphotype"))) %>%
  mutate(trait = lvls_revalue(
    trait,
    new_levels = c("Gemmae", "Glands", "Hairs", "Morphotype"))) %>%
  arrange(trait) %>%
  select(
    Trait = trait,
    `LL (independent model)` = logL_indep,
    `LL (dependent model)` = logL_dep,
    `Likelihood ratio` = likelihood_ratio,
    `P` = pval
  ) %>%
  write_csv(here::here("results/Table_S5.csv"))
```

**`r s_table("model-fit")`** Best-fitting models explaining community diversity metrics by climate and growth habit

MPDphy, standard effect size of mean phylogenetic distance; MNTDphy, standard effect size of mean nearest taxon distance; MPDfunc, standard effect size of mean functional distance; MNTDfunc, standard effect size of mean nearest functional distance; VPD, vapor pressure deficit, SD, standard deviation; AICc, corrected Akaike Information Criterion; P_moran, \pval\ value for the null hypothesis that there is spatial autocorrelation in the residuals as measured with Moran's *I*. Models within delta AICc 3 of the best-fitting model shown. Trait names refer to community-weighted mean values (see Methods). Frond length and width were highly correlated with rhizome diameter and not shown. For details on calculations of MPD and MNTD, see Methods.

```{r best-fit-mods}
# Format and write out table as CSV file
best_fit_div_models_moran %>%
  # Drop frond length and width (highly correlated with rhizome dia.)
  filter(resp_var %in% c("ntaxa", "mpd.obs.z.phy", "mntd.obs.z.phy", 
                   "mpd.obs.z.func", "mntd.obs.z.func",
                   "dissection", "sla", "stipe", "rhizome", "pinna")) %>%
  mutate(resp_var = factor(
        resp_var, 
        levels = c("ntaxa", "mpd.obs.z.phy", "mntd.obs.z.phy", 
                   "mpd.obs.z.func", "mntd.obs.z.func",
                   "dissection", "sla", "stipe", "rhizome", "pinna"))) %>%
  mutate(
    resp_var = lvls_revalue(
        resp_var, 
        new_levels = c("Richness", "MPDphy", "MNTDphy", 
                       "MPDfunc", "MNTDfunc",
                       "Dissection", "SLA", "Stipe length", "Rhizome diam.", "Pinna no.")) 
  ) %>%
  arrange(resp_var, delta_AICc) %>%
  mutate(
    modname = modname %>%
      str_replace_all("\\+", " \\+ ") %>%
      str_replace_all("\\.by\\.", " x ") %>%
      str_replace_all("habit", "Growth habit") %>%
      str_replace_all("temp_mean", "Mean temp.") %>%
      str_replace_all("temp_sd", "SD temp.") %>%
      str_replace_all("temp_max", "Max. temp.") %>%
      str_replace_all("vpd_mean", "Mean VPD") %>%
      str_replace_all("vpd_sd", "SD VPD") %>%
      str_replace_all("vpd_min", "Min. VPD")
  ) %>% 
  select(
    `Metric` = resp_var,
    `Model` = modname,
    AICc,
    `R2` = r2,
    delta_AICc,
    `Moran's I` = morans_I,
    `P_moran` = morans_I_pval
  ) %>%
  write_csv(here::here("results/Table_S6.csv"))
```

**`r s_figure("corr-plot")`** Correlation plot comparing results of functional community diversity analyses using different sets of traits as input. **(a)**, standard effect size of mean phylogenetic distance (MPD~func~) **(b)**, standard effect size of mean nearest taxon distance (MNTD~func~). For details on calculations of MPD~func~ and MNTD~func~, see Methods. Correlations (values in each tile) calculated with Pearson's correlation coefficient using the R package 'corrr'. All trait sets were scaled to standard deviation of each trait. The following trait sets were used: 'all' (all traits), 'size' (sporophyte traits related to size; frond length and width, stipe length, rhizome width, pinna number, SLA, degree of lamina dissection), 'other' (sporophyte traits not related to size; pinna number, SLA, degree of lamina dissection), 'gameto' (gametophyte traits; gametophyte morphotype, presence or absence of glands, hairs, and gemmae), 'reduced' (all traits except for frond length and width, which were highly correlated with stipe length and rhizome diameter). For trait sets that included traits with skewed distributions in their raw values (frond length and width, stipe length, and rhizome width), both log-transformed and untransformed sets were included. The log-transformed 'reduced' dataset was used for the main results.

```{r fig-s2}
library(corrr)

# Tweak names for easier viewing
func_comm_struc_combined_renamed <-
func_comm_struc_combined %>%
  mutate(dataset = str_remove_all(dataset, "func_comm_struc_test_fern_traits_")) %>%
  mutate(dataset = str_remove_all(dataset, "\\.pool")) %>%
  mutate(dataset = str_replace_all(dataset, "all_reduced", "reduced")) %>%
  mutate(dataset = str_remove_all(dataset, "scaled_")) %>%
  mutate(dataset = str_replace_all(dataset, "log_", "log-trans_"))

# Don't need log-transformed sets that don't include log-transformed traits
func_comm_struc_combined_renamed <- 
  func_comm_struc_combined_renamed %>%
  filter(
    !dataset %in% c("log-trans_gameto", "log-trans_other")
  )

# Convert to wide format, run corrr: MPD
mpd_corr <-
  func_comm_struc_combined_renamed %>%
  select(dataset, site, habit, mpd.obs.z) %>%
  spread(dataset, mpd.obs.z) %>%
  select(-site, -habit) %>%
  correlate %>% 
  rearrange(absolute = FALSE) # arrange so most correlated variables are closest

# Make plot 
# Modified from https://github.com/tidymodels/corrr/issues/35
order <- mpd_corr %>% 
  select(-rowname) %>% 
  colnames()

mpd_corr_plot <-
mpd_corr %>% 
  stretch(na.rm = TRUE) %>%
  mutate_at(c("x", "y"), forcats::fct_relevel, ... = order) %>% 
  ggplot(aes(x, y, fill = r)) +
  geom_tile() +
  geom_text(aes(label = as.character(fashion(r))), color = "white", size = 3) +
  scale_fill_scico(palette = "roma", breaks = c(-1, 1)) +
  labs(x = NULL, y = NULL, subtitle = "(a)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.subtitle = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

# Convert to wide format, run corrr: MNTD
mntd_corr <-
  func_comm_struc_combined_renamed %>%
  select(dataset, site, habit, mntd.obs.z) %>%
  spread(dataset, mntd.obs.z) %>%
  select(-site, -habit) %>%
  correlate %>% 
  rearrange(absolute = FALSE)

mntd_corr_plot <-
  mntd_corr %>% 
  stretch(na.rm = TRUE) %>%
  mutate_at(c("x", "y"), forcats::fct_relevel, ... = order) %>% # Use same order as MPD
  ggplot(aes(x, y, fill = r)) +
  geom_tile() +
  geom_text(aes(label = as.character(fashion(r))), color = "white", size = 3) +
  scale_fill_scico(palette = "roma", breaks = c(-1, 1)) +
  labs(x = NULL, y = NULL, subtitle = "(b)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.subtitle = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

fig_s1 <- mpd_corr_plot + mntd_corr_plot + plot_layout(nrow = 2, ncol = 1)

fig_s1 <- fig_s1 + plot_annotation(theme = theme(plot.margin = margin(
      0.2, 0.2, 0.2, 0.2, unit = "in")))

ggsave(plot = fig_s1, filename = here::here("results/Fig_S1.eps"), height = 8, width = 4, units = "in")
```

**`r s_figure("cwsd")`** Comparison of community-weighted standard deviations (CWSD) in traits of epiphytic and terrestrial fern communities on Moorea, French Polynesia. Epiphytic communities in green, terrestrial communities in brown. Points randomly jittered along x-axis to reduce overlap. Boxplots show median values (bold lines) by growth habit. Lower and upper hinges correspond to first and third quartiles, and whiskers extend to values within 1.5 × the interquartile range. Asterisks indicate significant differences in CWSD between epiphytic and terrestrial communities as determined by a two-sided \tval-test; \*\*\* = \pval{ }< 0.001; \*\* = \pval{ }< 0.01; \* = \pval{ }< 0.05 **(a)**, traits related to plant size **(b)**, traits not related to plant size.

```{r fig-s1}
loadd(cwsd_scatterplot, cache = canopy_cache)
ggsave(plot = cwsd_scatterplot, filename = here::here("results/Fig_S2.eps"), height = 6, width = 7, units = "in")
```

**References**
