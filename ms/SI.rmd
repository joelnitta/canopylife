---
title: ""
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
- BoldFont=Roboto-Bold.ttf
- ItalicFont=Roboto-Italic.ttf
- BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "new-phytologist.csl"]
    includes:
      in_header: new-phytologist.sty
header-includes: 
  - \usepackage{float}
  - \makeatletter\renewcommand*{\fps@figure}{H}\makeatother # Fix position of figs
  - \makeatletter\renewcommand*{\fps@table}{H}\makeatother # Fix position of tables
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE)

# Load analysis results
loadd(list = c(
  "taxonomic_data_for_si",
  "trait_data_for_si",
  "climate_ancova_results",
  "phylosig_binary_traits_strict",
  "correlated_evo_test_strict",
  "best_fit_div_models_moran",
  "func_comm_struc_combined"), 
  cache = canopy_cache)

# Load captions
source(here::here("ms/captions.R"))

# Set up table headers
si_table_header <- c(
  "New Phytologist Supporting Information",
  "Authors: Joel H. Nitta, James E. Watkins, Jr., and Charles C. Davis" %>% wrap_quotes,
  "Article acceptance date: 5 February 2020"
)
```

<!-- Set left justification  -->
\raggedright

<!-- Don't indent -->
\setlength{\parindent}{0ex}

***New Phytologist*** **Supporting Information**

Article title: Life in the canopy: Community trait assessments reveal substantial functional diversity among fern epiphytes

Authors: Joel H. Nitta, James E. Watkins, Jr., and Charles C. Davis

Article acceptance date: 5 February 2020

The following Supporting Information is available for this article:

**`r s_table("species-list")`** `r s_table_cap("species-list")` (see separate file)

'taxon code' is the name used for that taxon in analyses. 'informal variety' is a number assigned to infraspecific taxa that are morphologically and genetically distinct, but lack formal names distinguishing them. 'name source' indicates the source of the scientific name as follows: IPNI = International Plant Names Index (https://www.ipni.org/), TROPICOS = Missouri Botanical Garden taxonomic database (https://www.tropicos.org/), NCBI = National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi), Murdock and Smith 2003 = Murdock & Smith (2003). 'NA' indicates not applicable.

```{r species-list}
# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("species-list") %>% wrap_quotes
)

# Wrap footer at ca. 100 characters per line. Each line needs to be an element of the
# character vector.
footer <- "'taxon code' is the name used for that taxon in analyses. 'informal variety' is a number assigned to infraspecific taxa that are morphologically and genetically distinct, but lack formal names distinguishing them. 'name source' indicates the source of the scientific name as follows: IPNI = International Plant Names Index (https://www.ipni.org/), TROPICOS = Missouri Botanical Garden taxonomic database (https://www.tropicos.org/), NCBI = National Center for Biotechnology Information taxonomic database (https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi), Murdock and Smith 2003 = Murdock & Smith (2003). 'NA' indicates not applicable." %>% 
  str_wrap(width = 100) %>%
  str_split("\\n") %>%
  unlist %>%
  purrr::map_chr(wrap_quotes)

# Write out table with metadata
write_csv_with_meta(
  taxonomic_data_for_si, 
  here::here("results/Table_S1.csv"), 
  header,
  footer)
```

**`r s_table("trait-values")`** `r s_table_cap("trait-values")` (see separate file)

SLA, specific leaf area. Continuous measurements shown as mean, standard deviation (sample size). 'taxon code' is the name used for that taxon in analyses (see Table S1). For data source, L = lab observation of gametophyte cultured from spore, F = field observation of gametophyte subsequently identified using DNA barcoding, T = morphology inferred based on taxonomy, M = measurement of a field-collected specimen; cited references provided at end of SI. 'NA' indicates missing data.

```{r trait_data}
# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("trait-values") %>% wrap_quotes
)

footer <- "SLA, specific leaf area. Continuous measurements shown as mean, standard deviation (sample size). 'taxon code' is the name used for that taxon in analyses (see Table S1). For data source, L = lab observation of gametophyte cultured from spore, F = field observation of gametophyte subsequently identified using DNA barcoding, T = morphology inferred based on taxonomy, M = measurement of a field-collected specimen; cited references provided at end of SI. 'NA' indicates missing data." %>% 
  str_wrap(width = 100) %>%
  str_split("\\n") %>%
  unlist %>%
  purrr::map_chr(wrap_quotes)

# Write out table with metadata
write_csv_with_meta(
  trait_data_for_si, 
  here::here("results/Table_S2.csv"), 
  header,
  footer)
```

**`r s_table("ancova")`** `r s_table_cap("ancova")` (see separate file)

d.f., degrees of freedom; MS, mean squares.

```{r climate-ancova}
# Format table
climate_ancova_results_formatted <-
climate_ancova_results %>% 
  mutate(
    p.value = signif(p.value, 2) %>% format.pval(., digits = 1),
    meansq = round_t(meansq, 2),
    term = case_when(
      term == "habit" ~ "Growth habit",
      term == "el" ~ "Elevation",
      term == "habit:el" ~ "Growth habit × elevation",
      TRUE ~ term
    )
  ) %>%
  select(`Response variable` = variable, `Source of variation` = term, `d.f.` = df, MS = meansq, P = p.value)

# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("ancova") %>% wrap_quotes
)

footer <- "d.f., degrees of freedom; MS, mean squares." %>% wrap_quotes

# Write out table with metadata
write_csv_with_meta(
  climate_ancova_results_formatted, 
  here::here("results/Table_S3.csv"), 
  header,
  footer)
```

**`r s_table("phylosig-binary-strict")`** `r s_table_cap("phylosig-binary-strict")` (see separate file)

P_rnd, probability of obtaining the observed value of \D under random trait evolution; P_bm, probability of obtaining the observed value of \D under simulation of trait evolution by Brownian motion.

```{r phylosig-binary-strict}
# Format table
phylosig_binary_traits_strict_formatted <-
  phylosig_binary_traits_strict %>%
  mutate(D = round_t(D, 2)) %>%
  mutate(trait = factor(
    trait, 
    levels = c("habit", "gemmae", "glands", "hairs","morphotype"))) %>%
  mutate(trait = lvls_revalue(
    trait,
    new_levels = c("Epiphytic growth", "Gemmae", "Glands", "Hairs", "Cordate morphotype"))) %>%
  arrange(trait) %>%
  select(Trait = trait, `Number of presences` = num_present, `Number of absences` = num_absent, D,
         P_rnd = prob_random, P_bm = prob_brownian)

# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("phylosig-binary-strict") %>% wrap_quotes
)

footer <- "P_rnd, probability of obtaining the observed value of D under random trait evolution; P_bm, probability of obtaining the observed value of D under simulation of trait evolution by Brownian motion." %>%
  str_wrap(width = 100) %>%
  str_split("\\n") %>%
  unlist %>%
  purrr::map_chr(wrap_quotes)

# Write out table with metadata
write_csv_with_meta(
  phylosig_binary_traits_strict_formatted, 
  here::here("results/Table_S4.csv"), 
  header,
  footer)
```

**`r s_table("corr-evo-strict")`** `r s_table_cap("corr-evo-strict")` (see separate file)

LL, log likelihood. Each gametophyte trait was coded as a binary trait and tested for correlated evolution with growth habit (epiphytic vs. terrestrial). Lower log likelihood for the dependent model indicates correlation with growth habit. 

```{r corr-evo-strict}
# Format table
correlated_evo_test_strict_formatted <-
  correlated_evo_test_strict %>%
  mutate(trait = factor(
    trait, 
    levels = c("gemmae", "glands", "hairs","morphotype"))) %>%
  mutate(trait = lvls_revalue(
    trait,
    new_levels = c("Gemmae", "Glands", "Hairs", "Morphotype"))) %>%
  arrange(trait) %>%
  select(
    Trait = trait,
    `LL (independent model)` = logL_indep,
    `LL (dependent model)` = logL_dep,
    `Likelihood ratio` = likelihood_ratio,
    `P` = pval
  )

# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("corr-evo-strict") %>% wrap_quotes
)

footer <- "LL, log likelihood. Each gametophyte trait was coded as a binary trait and tested for correlated evolution with growth habit (epiphytic vs. terrestrial). Lower log likelihood for the dependent model indicates correlation with growth habit." %>%
  str_wrap(width = 100) %>%
  str_split("\\n") %>%
  unlist %>%
  purrr::map_chr(wrap_quotes)

# Write out table with metadata
write_csv_with_meta(
  correlated_evo_test_strict_formatted, 
  here::here("results/Table_S5.csv"), 
  header,
  footer)
```

**`r s_table("model-fit")`** `r s_table_cap("model-fit")` (see separate file)

MPDphy, standard effect size of mean phylogenetic distance; MNTDphy, standard effect size of mean nearest taxon distance; MPDfunc, standard effect size of mean functional distance; MNTDfunc, standard effect size of mean nearest functional distance; VPD, vapor pressure deficit, SD, standard deviation; AICc, corrected Akaike Information Criterion; P_moran, \pval\ value for the null hypothesis that there is spatial autocorrelation in the residuals as measured with Moran's *I*. Models within delta AICc 3 of the best-fitting model shown. Trait names refer to community-weighted mean values (see Methods). Frond length and width were highly correlated with rhizome diameter and not shown. For details on calculations of MPD and MNTD, see Methods.

```{r model-fit}
# Format table
best_fit_div_models_moran_formatted <-
best_fit_div_models_moran %>%
  # Drop frond length and width (highly correlated with rhizome dia.)
  filter(resp_var %in% c("ntaxa", "mpd.obs.z.phy", "mntd.obs.z.phy", 
                   "mpd.obs.z.func", "mntd.obs.z.func",
                   "dissection", "sla", "stipe", "rhizome", "pinna")) %>%
  mutate(resp_var = factor(
        resp_var, 
        levels = c("ntaxa", "mpd.obs.z.phy", "mntd.obs.z.phy", 
                   "mpd.obs.z.func", "mntd.obs.z.func",
                   "dissection", "sla", "stipe", "rhizome", "pinna"))) %>%
  mutate(
    resp_var = lvls_revalue(
        resp_var, 
        new_levels = c("Richness", "MPDphy", "MNTDphy", 
                       "MPDfunc", "MNTDfunc",
                       "Dissection", "SLA", "Stipe length", "Rhizome diam.", "Pinna no.")) 
  ) %>%
  arrange(resp_var, delta_AICc) %>%
  mutate(
    modname = modname %>%
      str_replace_all("\\+", " \\+ ") %>%
      str_replace_all("\\.by\\.", " x ") %>%
      str_replace_all("habit", "Growth habit") %>%
      str_replace_all("temp_mean", "Mean temp.") %>%
      str_replace_all("temp_sd", "SD temp.") %>%
      str_replace_all("temp_max", "Max. temp.") %>%
      str_replace_all("vpd_mean", "Mean VPD") %>%
      str_replace_all("vpd_sd", "SD VPD") %>%
      str_replace_all("vpd_min", "Min. VPD")
  ) %>% 
  select(
    `Metric` = resp_var,
    `Model` = modname,
    AICc,
    `R2` = r2,
    delta_AICc,
    `Moran's I` = morans_I,
    `P_moran` = morans_I_pval
  )

# Set header and footer
header <- c(
  si_table_header,
  s_table_nums("model-fit") %>% wrap_quotes
)

footer <- "MPDphy, standard effect size of mean phylogenetic distance; MNTDphy, standard effect size of mean nearest taxon distance; MPDfunc, standard effect size of mean functional distance; MNTDfunc, standard effect size of mean nearest functional distance; VPD, vapor pressure deficit, SD, standard deviation; AICc, corrected Akaike Information Criterion; P_moran, P value for the null hypothesis that there is spatial autocorrelation in the residuals as measured with Moran's I. Models within delta AICc 3 of the best-fitting model shown. Trait names refer to community-weighted mean values (see Methods). Frond length and width were highly correlated with rhizome diameter and not shown. For details on calculations of MPD and MNTD, see Methods." %>%
  str_wrap(width = 100) %>%
  str_split("\\n") %>%
  unlist %>%
  purrr::map_chr(wrap_quotes)

# Write out table with metadata
write_csv_with_meta(
  best_fit_div_models_moran_formatted, 
  here::here("results/Table_S6.csv"), 
  header,
  footer)

```

\clearpage

```{r Fig-S1, fig.height = 6, fig.width = 7, fig.cap = ""}
loadd(cwsd_scatterplot, cache = canopy_cache)

cwsd_scatterplot
```

**`r s_figure("cwsd")`** `r s_figure_cap("cwsd")`. Epiphytic communities in green, terrestrial communities in brown. Points randomly jittered along x-axis to reduce overlap. Boxplots show median values (bold lines) by growth habit. Lower and upper hinges correspond to first and third quartiles, and whiskers extend to values within 1.5 × the interquartile range. Asterisks indicate significant differences in CWSD between epiphytic and terrestrial communities as determined by a two-sided \tval-test; \*\*\* = \pval{ }< 0.001; \* = \pval{ }< 0.05 **(a)**, traits related to plant size **(b)**, traits not related to plant size. Response variable abbreviations: SLA, specific leaf area.

\clearpage

```{r Fig-S2, fig.height = 8, fig.width = 4, fig.cap = ""}

# Tweak names for easier viewing
func_comm_struc_combined_renamed <-
func_comm_struc_combined %>%
  mutate(dataset = str_remove_all(dataset, "func_comm_struc_test_fern_traits_")) %>%
  mutate(dataset = str_remove_all(dataset, "\\.pool")) %>%
  mutate(dataset = str_replace_all(dataset, "all_reduced", "reduced")) %>%
  mutate(dataset = str_remove_all(dataset, "scaled_")) %>%
  mutate(dataset = str_replace_all(dataset, "log_", "log-trans_"))

# Don't need log-transformed sets that don't include log-transformed traits
func_comm_struc_combined_renamed <- 
  func_comm_struc_combined_renamed %>%
  filter(
    !dataset %in% c("log-trans_gameto", "log-trans_other")
  )

# Convert to wide format, run corrr: MPD
mpd_corr <-
  func_comm_struc_combined_renamed %>%
  select(dataset, site, habit, mpd.obs.z) %>%
  spread(dataset, mpd.obs.z) %>%
  select(-site, -habit) %>%
  correlate %>% 
  rearrange(absolute = FALSE) # arrange so most correlated variables are closest

# Make plot 
# Modified from https://github.com/tidymodels/corrr/issues/35
order <- mpd_corr %>% 
  select(-rowname) %>% 
  colnames()

mpd_corr_plot <-
mpd_corr %>% 
  stretch(na.rm = TRUE) %>%
  mutate_at(c("x", "y"), forcats::fct_relevel, ... = order) %>% 
  ggplot(aes(x, y, fill = r)) +
  geom_tile() +
  geom_text(aes(label = as.character(fashion(r))), color = "white", size = 3) +
  scale_fill_scico(palette = "roma", breaks = c(-1, 1)) +
  labs(x = NULL, y = NULL, subtitle = "(a)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.subtitle = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

# Convert to wide format, run corrr: MNTD
mntd_corr <-
  func_comm_struc_combined_renamed %>%
  select(dataset, site, habit, mntd.obs.z) %>%
  spread(dataset, mntd.obs.z) %>%
  select(-site, -habit) %>%
  correlate %>% 
  rearrange(absolute = FALSE)

mntd_corr_plot <-
  mntd_corr %>% 
  stretch(na.rm = TRUE) %>%
  mutate_at(c("x", "y"), forcats::fct_relevel, ... = order) %>% # Use same order as MPD
  ggplot(aes(x, y, fill = r)) +
  geom_tile() +
  geom_text(aes(label = as.character(fashion(r))), color = "white", size = 3) +
  scale_fill_scico(palette = "roma", breaks = c(-1, 1)) +
  labs(x = NULL, y = NULL, subtitle = "(b)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.subtitle = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  )

fig_s2 <- mpd_corr_plot + mntd_corr_plot + plot_layout(nrow = 2, ncol = 1)

fig_s2 <- fig_s2 + plot_annotation(theme = theme(plot.margin = margin(
      0.2, 0.2, 0.2, 0.2, unit = "in")))

fig_s2
```

**`r s_figure("corr-plot")`** `r s_figure_cap("corr-plot")`. **(a)**, standard effect size of mean phylogenetic distance (MPD~func~) **(b)**, standard effect size of mean nearest taxon distance (MNTD~func~). For details on calculations of MPD~func~ and MNTD~func~, see Methods. Correlations between functional diversity as measured with different sets of traits (values in each tile) calculated with Pearson's correlation coefficient using the R package 'corrr'. All trait sets were scaled to standard deviation of each trait. The following trait sets were used: 'all' (all traits), 'size' (sporophyte traits related to size; frond length and width, stipe length, rhizome width, pinna number, SLA, degree of lamina dissection), 'other' (sporophyte traits not related to size; pinna number, SLA, degree of lamina dissection), 'gameto' (gametophyte traits; gametophyte morphotype, presence or absence of glands, hairs, and gemmae), 'reduced' (all traits except for frond length and width, which were highly correlated with stipe length and rhizome diameter). For trait sets that included traits with skewed distributions in their raw values (frond length and width, stipe length, and rhizome width), both log-transformed and untransformed sets were included. The log-transformed 'reduced' dataset was used for the main results.

\clearpage

**References**

<!-- There is a bug somewhere in Rmd -> tex -> pdf using pandoc such that the 
first bold words until a period in each reference do not appear bold. As a 
work-around, first render to pdf with `bibliography` and `nocite` in the yaml, 
then convert Rmd -> tex -> docx with pandoc, edit docx manually to fix formatting, 
then docx -> md with pandoc, and paste properly formatted refs below -->

**Atkinson L**. **1975**. The gametophyte of five Old World thelypteroid
ferns. *Phytomorphology* **25**: 38--54.

**Bierhorst DW**. **1967**. The gametophyte of *Schizaea dichotoma*.
*American Journal of Botany* **54**: 538--549.

**Brownsey PJ**. **1987**. A review of the fern genus *Hypolepis*
(Dennstaedtiaceae) in the Malesian and Pacific regions. *Blumea* **32**:
227--276.

**Copeland EB**. **1932**. Pteridophytes of the Society Islands.
*Bernice P. Bishop Museum Bulletin* **93**: 1--86.

**Lloyd RM**. **1980**. Reproductive biology and gametophyte morphology
of New World populations of *Acrostichum aureum*. *American Fern
Journal* **70**: 99--110.

**Martin K, Sini S, Zhang C, Slater A, Madhusoodanan P**. **2006**.
Efficient induction of apospory and apogamy in vitro in silver fern
(*Pityrogramma calomelanos* L.). *Plant Cell Reports* **25**:
1300--1307.

**Murdock AG, Smith AR**. **2003**. Pteridophytes of Moorea, French
Polynesia, with a new species, *Tmesipteris gracilis* (Psilotaceae).
*Pacific Science* **57**: 253--265.

**National Museum of Nature and Science**. **2008**. *Illustrated Flora
of Ferns and Fern Allies of South Pacific Islands* (T Nakamura and S
Matsumoto, Eds.). Tokai University Press.

**Nayar BK, Kaur S**. **1971**. Gametophytes of homosporous ferns. *The
Botanical Review* **37**: 295--396.

**Pagel M**. **1994**. Detecting correlated evolution on phylogenies: A
general method for the comparative analysis of discrete characters.
*Proceedings of the Royal Society B: Biological Sciences* **255**:
37--45.

**Palmer DD**. **2003**. *Hawaii's Ferns and Fern Allies*. Honolulu:
University of Hawaii Press.

**Royal Botanic Gardens and Domain Trust**. **2004**. *Flora of New
South Wales. PlantNET (The NSW Plant Information Network System)* [WWW
document] URL <http://plantnet.rbgsyd.nsw.gov.au/floraonline.htm>.
[accessed 1 January 2020].

**Tigerschiöld E**. **1989**. Dehiscence of antheridia in thelypteroid
ferns. *Nordic Journal of Botany* **9**: 407--412.

**Tigerschiöld E**. **1990**. Gametophytes of some Ceylonese species of
Thelypteridaceae. *Nordic Journal of Botany* **9**: 657--664.

**Zhang K, Shi L, Zhang X, Jiang C, Tim-Chun W**. **2008**. Gametophyte
morphology and development of six chinese species of *Pteris*
(Pteridaceae). *American Fern Journal* **98**: 33--41.
